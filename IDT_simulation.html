<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>IDT Anchor Horizon Recommender — IS/OS + Charts</title>

<style>
  :root{
    --bg:#0e1116; --card:#151922; --text:#e8eaed; --muted:#9aa0a6; --border:#2a2f3a;
    --chart-h: 280px;
    --os:#22c55e; --is:#60a5fa; --unk:#f59e0b; --bad:#ef4444;
  }
  body{margin:0;background:var(--bg);color:var(--text);font:14px/1.5 system-ui,Segoe UI,Roboto,Helvetica,Arial}
  .wrap{max-width:1280px;margin:0 auto;padding:24px}
  .sub{color:var(--muted);margin-bottom:20px}
  .card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:12px;min-width:0}
  .controls{display:grid;grid-template-columns:1.3fr 1fr 1fr;gap:16px}
  select,input[type="range"]{width:100%}
  .slider-labels{display:flex;justify-content:space-between;color:var(--muted);font-size:12px;margin-top:6px}
  .row{display:flex;gap:16px;flex-wrap:wrap;margin-top:12px}

  .pill{padding:6px 10px;border-radius:999px;background:#1b2130;border:1px solid var(--border);color:#dfe3ea;cursor:pointer;display:inline-flex;gap:8px;align-items:center}
  .pill.good{background:rgba(15,157,88,.15);border-color:#224f38;color:#b9ffd3}
  .pill.warn{background:rgba(122,162,255,.15);border-color:#283e7a;color:#cfe0ff}
  .pill.alt {background:rgba(244,180,0,.12);border-color:#564600;color:#ffe9ad}

  .pill.tagOS{background:rgba(34,197,94,.12);border-color:rgba(34,197,94,.35);color:#c9ffe0}
  .pill.tagIS{background:rgba(96,165,250,.12);border-color:rgba(96,165,250,.35);color:#d6e8ff}
  .pill.tagUNK{background:rgba(245,158,11,.12);border-color:rgba(245,158,11,.35);color:#ffe7bf}
  .pill.tagBAD{background:rgba(239,68,68,.12);border-color:rgba(239,68,68,.35);color:#ffd0d0}

  .badgeDot{width:8px;height:8px;border-radius:999px;display:inline-block}
  .dotOS{background:var(--os)}
  .dotIS{background:var(--is)}
  .dotUNK{background:var(--unk)}
  .dotBAD{background:var(--bad)}

  .recs{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}

  .panes{
    display:grid;
    grid-template-columns:minmax(0, 1fr) minmax(0, 1fr);
    gap:16px;
    margin-top:12px;
    align-items:start;
  }
  .pane{display:flex;flex-direction:column;gap:16px;min-width:0}

  .chartbox{position:relative;height:var(--chart-h);width:100%}
  .chartbox canvas{
    width:100% !important;height:100% !important;display:block;
    background:#0f1420;border:1px solid var(--border);border-radius:12px;padding:8px;
  }

  .tableWrap{overflow-x:auto; max-width:100%;}
  table{
    width:100%;
    border-collapse:collapse;
    background:var(--card);
    border:1px solid var(--border);
    border-radius:12px;
    overflow:visible;
    table-layout:fixed;
  }
  thead th{
    background:#1b2130;
    padding:10px;
    border-bottom:1px solid var(--border);
    text-align:left;
    white-space:normal;
    line-height:1.15;
    font-size:12px;
    overflow:hidden;
    text-overflow:ellipsis;
  }
  tbody td{
    padding:10px;
    border-top:1px solid var(--border);
    vertical-align:top;
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
  }
  .num{font-variant-numeric:tabular-nums;text-align:right}
  table thead th:first-child{ text-align:left; }
  table thead th:not(:first-child){ text-align:right; }
  table tbody td.num{ text-align:right; }

  .foot{margin-top:10px;color:var(--muted);font-size:12px}
  .section-title{font-weight:700;margin-bottom:6px}
  .kwrap{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .small-select{width:auto;min-width:84px;padding-right:18px}
  .panel-controls{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin-bottom:8px}
  .muted{color:var(--muted)}

  #riskTable, #simTable { font-size:12px; }
  #simTable th:last-child, #simTable td:last-child{ min-width:120px; width:120px; }

  .chk-scroll{
    max-height: 98px;
    overflow:auto;
    border:1px solid var(--border);
    border-radius:10px;
    padding:8px;
    background:#101624;
  }
  .chk-wrap{display:flex;gap:8px;flex-wrap:wrap}
  .chk-wrap label{
    display:inline-flex;gap:6px;align-items:center;
    background:#121a2a;border:1px solid var(--border);
    padding:4px 8px;border-radius:999px
  }

  .chart-spacer{height:10px}

  .tagbar{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin-top:8px}
  .taginfo{display:flex;gap:10px;flex-wrap:wrap;align-items:center}

  .compareWrap{
    display:flex;gap:10px;flex-wrap:wrap;align-items:center;
    margin-top:10px;padding-top:10px;border-top:1px solid var(--border);
  }
  .toggle{
    display:inline-flex;gap:8px;align-items:center;
    padding:6px 10px;border-radius:999px;background:#121a2a;border:1px solid var(--border);
    cursor:pointer;user-select:none
  }
  .toggle input{width:auto}
  .hint{color:var(--muted);font-size:12px}

  @media (max-width: 980px){
    .controls{grid-template-columns:1fr}
    .panes{grid-template-columns:1fr}
  }
</style>
</head>

<body>
<div class="wrap">
  <div style="display:flex;align-items:center;justify-content:left;gap:12px;margin-bottom:12px">
      <a href="https://quantumyield.ai" target="_blank" rel="noopener noreferrer">
        <img src="https://quantumyield.ai/logo.jpg" alt="Quantum Yield Logo" style="height:36px;width:auto;border-radius:6px;box-shadow:0 2px 6px rgba(0,0,0,.25)">
      </a>
      <h2 style="margin:0">IDT Simulation</h2>
  </div>

  <div class="sub">
    <strong>Daily intra-day trading</strong> simulation using a rolling 30-day training window on L1/L2/L3 features.
    Your risk and performance tolerances rank anchor horizons to surface the best-fit trading profiles.
  </div>

  <div class="controls">
    <div class="card">
      <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px">
        <div>
          <label for="asof">As-of Date</label>
          <select id="asof"></select>
          <div class="foot">Format: <b>yyyymmdd</b></div>
        </div>
        <div>
          <label for="instrument">Instrument</label>
          <select id="instrument">
            <option value="ZN">ZN (10Y Treasury Futures)</option>
            <option value="ES" selected>ES (S&P 500 Futures)</option>
          </select>
        </div>
        <div>
          <label for="tagSel">View</label>
          <select id="tagSel">
            <option value="AUTO" selected>Auto (prefer OS)</option>
            <option value="OS">OS only</option>
            <option value="IS">IS only</option>
          </select>
          <div class="foot">Auto picks <b>OS if present</b>; otherwise falls back to IS.</div>
        </div>
      </div>

      <div class="compareWrap">
        <label class="toggle" title="Show OS vs IS side-by-side deltas (scores + key metrics).">
          <input id="compareToggle" type="checkbox" />
          Compare OS ↔ IS
        </label>
        <span class="hint">Comparison uses same (asof,symbol) and shows OS minus IS deltas per horizon.</span>
      </div>

      <div class="tagbar" id="tagBar"></div>
      <div class="foot" id="status" style="margin-top:8px"></div>
    </div>

    <div class="card">
      <label for="risk">Risk Tolerance</label>
      <input id="risk" type="range" min="0" max="100" step="1" value="50" />
      <div class="slider-labels"><span>Conservative</span><span>Balanced</span><span>Aggressive</span></div>
      <div class="foot">
        <b>Risk Score (0–10): safer/better is higher.</b><br/>
        Computed from normalized Sharpe (good ↑), Turnover (good ↓), MaxDD (good ↓). Slider shifts their weights.
      </div>
    </div>

    <div class="card">
      <label for="perf">Performance Tolerance</label>
      <input id="perf" type="range" min="0" max="100" step="1" value="60" />
      <div class="slider-labels"><span>Conservative</span><span>Balanced</span><span>Aggressive</span></div>
      <div class="foot">
        <b>Perf Score (0–10): better is higher.</b><br/>
        Computed from normalized Total PnL (↑), Avg PnL (↑), Win% (↑). Slider shifts their weights.
      </div>
    </div>
  </div>

  <div class="row">
    <div class="card" style="flex:1">
      <div class="section-title">Top-K Recommendations</div>
      <div class="kwrap">
        <label for="topk">Show top</label>
        <select id="topk" class="small-select">
          <option>1</option><option>2</option><option selected>3</option>
          <option>4</option><option>5</option><option>6</option><option>7</option>
        </select>
        <span>anchors</span>
        <span id="viewPill" class="pill tagUNK" style="margin-left:auto"></span>
      </div>
      <div style="margin-top:10px"><b>Risk-based (safer / better higher)</b></div>
      <div id="recsRisk" class="recs"></div>
      <div style="margin-top:10px"><b>Performance-based</b></div>
      <div id="recsPerf" class="recs"></div>

      <div id="compareBox" style="display:none;margin-top:14px;padding-top:12px;border-top:1px solid var(--border)">
        <div class="section-title">OS ↔ IS Horizon Deltas (OS − IS)</div>
        <div class="foot">If a horizon exists in only one tag, it will be omitted here.</div>
        <div class="tableWrap">
          <table id="cmpTable">
            <thead>
              <tr>
                <th>Horizon</th>
                <th>Δ RiskScore</th>
                <th>Δ PerfScore</th>
                <th>Δ Sharpe</th>
                <th>Δ MaxDD</th>
                <th>Δ TotalPnL</th>
                <th>Δ Win%</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>

    </div>
  </div>

  <div class="panes">
    <!-- LEFT PANE (RISK) -->
    <div class="pane">
      <div class="card" id="riskCard">
        <div class="section-title">Risk by Horizon</div>
        <div class="panel-controls">
          <label for="riskMetricSel">Metric</label>
          <select id="riskMetricSel" class="small-select">
            <option value="Sharpe" selected>Sharpe</option>
            <option value="MaxDD">MaxDD</option>
            <option value="Turnover">Turnover</option>
            <option value="riskScoreN">Risk Score (0–10)</option>
          </select>
          <span class="muted">Anchors</span>
          <button id="riskAnchorsAll" class="pill">All</button>
          <button id="riskAnchorsNone" class="pill">None</button>
        </div>

        <div class="chk-scroll">
          <div id="anchorChecksRisk" class="chk-wrap"></div>
        </div>

        <div class="chart-spacer"></div>
        <div class="chartbox"><canvas id="riskChart"></canvas></div>
      </div>

      <div class="card">
        <div class="section-title">Risk Metrics</div>
        <div class="tableWrap">
          <table id="riskTable">
            <thead>
              <tr>
                <th>Horizon (ms)</th>
                <th>Sharpe</th>
                <th>Turnover</th>
                <th>MaxDD</th>
                <th>Risk Score (0–10)</th>
              </tr>
            </thead><tbody></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- RIGHT PANE (PERFORMANCE) -->
    <div class="pane">
      <div class="card" id="perfCard">
        <div class="section-title">Performance by Horizon</div>
        <div class="panel-controls">
          <label for="metricSel">Metric</label>
          <select id="metricSel" class="small-select">
            <option value="total_pnl_bps">Total PnL (bps)</option>
            <option value="avg_pnl_bps">Avg PnL (bps)</option>
            <option value="med_pnl_bps">Median PnL (bps)</option>
            <option value="win_pct" selected>Win %</option>
            <option value="trades">Trades</option>
            <option value="perfScoreN">Perf Score (0–10)</option>
          </select>
          <span class="muted">Anchors</span>
          <button id="anchorsAll" class="pill">All</button>
          <button id="anchorsNone" class="pill">None</button>
        </div>

        <div class="chk-scroll">
          <div id="anchorChecks" class="chk-wrap"></div>
        </div>

        <div class="chart-spacer"></div>
        <div class="chartbox"><canvas id="pnlChart"></canvas></div>
      </div>

      <div class="card">
        <div class="section-title">Simulation Results</div>
        <div class="tableWrap">
          <table id="simTable">
            <thead>
              <tr>
                <th>Horizon</th>
                <th>Trades</th>
                <th>Total PnL (bps)</th>
                <th>Avg PnL</th>
                <th>Median PnL</th>
                <th>Win %</th>
                <th>Perf Score (0–10)</th>
              </tr>
            </thead><tbody></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script>
/* ========= JSON Data Source ========= */
const JSON_URL = "./idt_daily_data.json";

/* -------- Colors per metric -------- */
const METRIC_COLORS = {
  Sharpe:'#4ade80', MaxDD:'#ef4444', Turnover:'#f59e0b', riskScoreN:'#06b6d4',
  total_pnl_bps:'#60a5fa', avg_pnl_bps:'#a78bfa', med_pnl_bps:'#ec4899', win_pct:'#10b981', trades:'#f97316', perfScoreN:'#eab308'
};

let cache = {};                 // key = `${asof}_${sym}_${tag}`
let pnlChart=null, riskChart=null;
let lastRows=[];
let renderSeq=0, currentKey="";
let RAW=null;

function syncChartCardHeights(){
  const left = document.getElementById('riskCard');
  const right = document.getElementById('perfCard');
  if(!left || !right) return;
  left.style.height = right.style.height = 'auto';
  const h = Math.max(left.getBoundingClientRect().height, right.getBoundingClientRect().height);
  left.style.height = right.style.height = h + 'px';
}

async function loadJSON(){
  const r = await fetch(JSON_URL, {cache:"no-store"});
  if(!r.ok) throw new Error(`Failed to load ${JSON_URL} (${r.status})`);
  const j = await r.json();
  if(!Array.isArray(j)) throw new Error("idt_daily_data.json must be an array of records");
  return j;
}

function num(x, dflt=0){
  const v = +x;
  return Number.isFinite(v) ? v : dflt;
}
function yyyymmdd(asof){
  const s = String(asof||"");
  return (s.length === 8 && s.startsWith("20")) ? s : null;
}

/* --- Auto classify IS/OS as a safety check --- */
function autoTag(asof, mstart, mend){
  const A=String(asof||""), S=String(mstart||""), E=String(mend||"");
  if(A.length!==8 || S.length!==8 || E.length!==8) return "UNK";
  if(S > E) return "UNK";
  return (S <= A && A <= E) ? "IS" : "OS";
}
function tagClass(t){
  const T=String(t||"").toUpperCase();
  if(T==="OS") return {cls:"tagOS", dot:"dotOS", label:"OS"};
  if(T==="IS") return {cls:"tagIS", dot:"dotIS", label:"IS"};
  return {cls:"tagUNK", dot:"dotUNK", label:"UNK"};
}

function populateAsofs(){
  const sel = document.getElementById('asof');
  const asofs = Array.from(new Set(RAW.map(r => yyyymmdd(r.asof)).filter(Boolean))).sort();
  sel.innerHTML = asofs.map(d=>`<option value="${d}">${d}</option>`).join('');
  if(asofs.length) sel.value = asofs[asofs.length-1];
}

/* Determine which tags exist for (asof,sym) */
function tagsAvailable(asof, sym){
  const SYM=String(sym||"").toUpperCase();
  const ASOF=String(asof||"");
  const tags = new Set(
    RAW.filter(r => String(r.symbol||"").toUpperCase()===SYM && String(r.asof||"")===ASOF)
       .map(r => String(r.tag||"").toUpperCase())
       .filter(Boolean)
  );
  return Array.from(tags);
}

function resolveViewTag(viewMode, asof, sym){
  const mode = String(viewMode||"AUTO").toUpperCase();
  if(mode==="OS" || mode==="IS") return mode;
  const avail = tagsAvailable(asof, sym);
  if(avail.includes("OS")) return "OS";
  if(avail.includes("IS")) return "IS";
  return "OS";
}

/* Build rows for (asof,symbol,tag) */
function buildRowsFor(asof, sym, tag){
  const SYM = String(sym||"").toUpperCase();
  const TAG = String(tag||"").toUpperCase();
  const ASOF = String(asof||"");

  const slice = RAW.filter(r =>
    String(r.symbol||"").toUpperCase() === SYM &&
    String(r.asof||"") === ASOF &&
    String(r.tag||"").toUpperCase() === TAG
  );

  if(!slice.length) return {rows:[], meta:null};

  const rows = slice.map(r => {
      const h = num(r.horizon_ms ?? r.h_ms ?? r.horizon, NaN);

      const Sharpe   = num(r.Sharpe ?? r.sharpe, NaN);
      const Turnover = num(r.Turnover ?? r.num_trades ?? r.trades ?? r.count, 0);
      const MaxDD    = num(r.MaxDD ?? r.maxdd ?? r.mxDD, 0);

      const avg    = num(r.avg_pnl_bps ?? r.mean_trades_bps ?? r.mean_all_bps, 0);
      const med    = num(r.med_pnl_bps ?? r.median_bps, 0);
      const winpct = Number.isFinite(num(r.win_pct, NaN)) ? num(r.win_pct)
                   : (Number.isFinite(num(r.win_rate, NaN)) ? num(r.win_rate) : 0);

      const total  = Number.isFinite(num(r.total_pnl_bps, NaN)) ? num(r.total_pnl_bps) : (avg * Turnover);

      const mstart = r.model_start;
      const mend   = r.model_end;
      const backendTag = String(r.tag||"").toUpperCase();
      const aTag = autoTag(ASOF, mstart, mend); // safety check
      const tagMismatch = (backendTag !== "UNK" && aTag !== "UNK" && backendTag !== aTag);

      return {
        h_ms:h,

        trades:Turnover,
        total_pnl_bps: total,
        avg_pnl_bps: avg,
        med_pnl_bps: med,
        win_pct: winpct,

        Sharpe: (Number.isFinite(Sharpe) ? Sharpe : null),
        Turnover, MaxDD,

        tag: backendTag,
        auto_tag: aTag,
        tag_mismatch: tagMismatch,

        model_start: mstart,
        model_end: mend,
        src_file: r.src_file
      };
    })
    .filter(r => Number.isFinite(r.h_ms))
    .sort((a,b)=>a.h_ms-b.h_ms);

  const dup = rows.length - new Set(rows.map(r=>r.h_ms)).size;
  return { rows, meta:{asof:ASOF,symbol:SYM,tag:TAG,rows:rows.length,dup_horizons:dup} };
}

/* ------------------------ Normalization helpers ------------------------ */
function minMaxBounds(rows, key){
  const vals = rows.map(r => +r[key]).filter(v => Number.isFinite(v));
  if(!vals.length) return {min:0, max:0};
  return {min: Math.min(...vals), max: Math.max(...vals)};
}
function mm01(v, min, max){
  if(!Number.isFinite(v)) return 0.5;
  const span = (max - min);
  if(!Number.isFinite(span) || span <= 1e-12) return 0.5;
  return (v - min) / span;
}
function clamp01(x){ return Math.max(0, Math.min(1, x)); }

/* ------------------------ Weights driven by sliders ------------------------ */
function riskWeights(x){
  const t = clamp01(x/100);
  const sharpeW = 0.35 + 0.35*t;
  const ddW     = 0.45 - 0.25*t;
  const toW     = 0.20 - 0.10*t;
  const s = sharpeW + ddW + toW;
  return { wS: sharpeW/s, wD: ddW/s, wT: toW/s };
}
function perfWeights(x){
  const t = clamp01(x/100);
  const totW = 0.35 + 0.35*t;
  const avgW = 0.15 + 0.15*t;
  const winW = 0.50 - 0.50*t;
  const s = totW + avgW + winW;
  return { vTot: totW/s, vAvg: avgW/s, vWin: winW/s };
}

/* ------------------------ Scoring (INTUITIVE) ------------------------ */
function recomputeScoresAndNormalize(){
  if(!lastRows.length) return;

  const bSharpe = minMaxBounds(lastRows, 'Sharpe');
  const bTO     = minMaxBounds(lastRows, 'Turnover');
  const bDD     = minMaxBounds(lastRows, 'MaxDD');

  const bTot    = minMaxBounds(lastRows, 'total_pnl_bps');
  const bAvg    = minMaxBounds(lastRows, 'avg_pnl_bps');
  const bWin    = minMaxBounds(lastRows, 'win_pct');

  const W = riskWeights(+document.getElementById('risk').value);
  const P = perfWeights(+document.getElementById('perf').value);

  lastRows.forEach(r=>{
    const sharpeN = clamp01(mm01(num(r.Sharpe, NaN), bSharpe.min, bSharpe.max));
    const toN     = clamp01(mm01(r.Turnover, bTO.min, bTO.max));
    const ddN     = clamp01(mm01(r.MaxDD, bDD.min, bDD.max));

    const riskRaw01 = (W.wS * sharpeN) + (W.wT * (1 - toN)) + (W.wD * (1 - ddN));
    r.riskScoreN = 10 * clamp01(riskRaw01);

    const totN = clamp01(mm01(r.total_pnl_bps, bTot.min, bTot.max));
    const avgN = clamp01(mm01(r.avg_pnl_bps, bAvg.min, bAvg.max));
    const winN = clamp01(mm01(r.win_pct, bWin.min, bWin.max));

    const perfRaw01 = (P.vTot * totN) + (P.vAvg * avgN) + (P.vWin * winN);
    r.perfScoreN = 10 * clamp01(perfRaw01);
  });
}

/* ------------------------ Chart builders ------------------------ */
function commonOptions(){
  return {
    responsive:true, maintainAspectRatio:false,
    layout:{padding:{top:0,right:0,bottom:0,left:0}},
    plugins:{legend:{display:true, position:'top', labels:{boxWidth:10}}},
    scales:{x:{grid:{display:false}}, y:{beginAtZero:true}}
  };
}
function makeBarChart(ctx, labels, data, label, color){
  return new Chart(ctx,{ type:'bar',
    data:{ labels, datasets:[{ label, data, backgroundColor: color, borderColor: color, borderWidth: 1 }]},
    options: commonOptions()
  });
}
function makeLineChart(ctx, labels, data, label, color){
  return new Chart(ctx,{ type:'line',
    data:{ labels, datasets:[{ label, data, borderColor: color, backgroundColor: color, borderWidth: 2, pointRadius:2, tension:0.25, fill:false }]},
    options: commonOptions()
  });
}

/* ------------------------ Performance panel ------------------------ */
function buildAnchorChecksPerf(rows){
  const wrap = document.getElementById('anchorChecks');
  wrap.innerHTML = rows.map(r => `<label><input type="checkbox" class="anchorChk" value="${r.h_ms}" checked> ${r.h_ms} ms</label>`).join('');
  wrap.querySelectorAll('.anchorChk').forEach(cb=> cb.addEventListener('change', ()=>{ updatePerfChart(); syncChartCardHeights(); }));
  document.getElementById('anchorsAll').onclick  = (e)=>{ e.preventDefault(); wrap.querySelectorAll('.anchorChk').forEach(c=>c.checked=true);  updatePerfChart(); syncChartCardHeights(); };
  document.getElementById('anchorsNone').onclick = (e)=>{ e.preventDefault(); wrap.querySelectorAll('.anchorChk').forEach(c=>c.checked=false); updatePerfChart(); syncChartCardHeights(); };
  document.getElementById('metricSel').onchange = ()=>{ updatePerfChart(); syncChartCardHeights(); };
}
function getSelectedPerfAnchors(){ return Array.from(document.querySelectorAll('.anchorChk')).filter(c=>c.checked).map(c=>+c.value); }
function updatePerfChart(){
  if(!lastRows.length) return;
  recomputeScoresAndNormalize();
  const metric = document.getElementById('metricSel').value;
  const sel = new Set(getSelectedPerfAnchors());
  const rows = lastRows.filter(r => sel.has(r.h_ms));
  const labels = rows.map(r=>r.h_ms+' ms');
  const data = rows.map(r => r[metric]);
  const color = METRIC_COLORS[metric] || '#7aa2ff';
  if(pnlChart){ pnlChart.destroy(); }
  pnlChart = makeBarChart(document.getElementById('pnlChart').getContext('2d'), labels, data, metric, color);
  renderTables(); updateRecommendations();
}

/* ------------------------ Risk panel ------------------------ */
function buildAnchorChecksRisk(rows){
  const wrap = document.getElementById('anchorChecksRisk');
  wrap.innerHTML = rows.map(r => `<label><input type="checkbox" class="riskAnchorChk" value="${r.h_ms}" checked> ${r.h_ms} ms</label>`).join('');
  wrap.querySelectorAll('.riskAnchorChk').forEach(cb=> cb.addEventListener('change', ()=>{ updateRiskChart(); syncChartCardHeights(); }));
  document.getElementById('riskAnchorsAll').onclick  = (e)=>{ e.preventDefault(); wrap.querySelectorAll('.riskAnchorChk').forEach(c=>c.checked=true);  updateRiskChart(); syncChartCardHeights(); };
  document.getElementById('riskAnchorsNone').onclick = (e)=>{ e.preventDefault(); wrap.querySelectorAll('.riskAnchorChk').forEach(c=>c.checked=false); updateRiskChart(); syncChartCardHeights(); };
  document.getElementById('riskMetricSel').onchange = ()=>{ updateRiskChart(); syncChartCardHeights(); };
}
function getSelectedRiskAnchors(){ return Array.from(document.querySelectorAll('.riskAnchorChk')).filter(c=>c.checked).map(c=>+c.value); }
function updateRiskChart(){
  if(!lastRows.length) return;
  recomputeScoresAndNormalize();
  const metric = document.getElementById('riskMetricSel').value;
  const sel = new Set(getSelectedRiskAnchors());
  const rows = lastRows.filter(r => sel.has(r.h_ms));
  const labels = rows.map(r=>r.h_ms+' ms');
  const data = rows.map(r => r[metric]);
  const color = METRIC_COLORS[metric] || '#7aa2ff';
  if(riskChart){ riskChart.destroy(); }
  riskChart = makeLineChart(document.getElementById('riskChart').getContext('2d'), labels, data, metric, color);
  renderTables(); updateRecommendations();
}

/* ------------------------ Tables + Recs ------------------------ */
function renderTables(){
  const rt=document.querySelector('#riskTable tbody');
  rt.innerHTML = lastRows.map(r=>`
    <tr>
      <td>${r.h_ms}</td>
      <td class="num">${(r.Sharpe===null ? '—' : num(r.Sharpe,0).toFixed(3))}</td>
      <td class="num">${num(r.Turnover,0)}</td>
      <td class="num">${num(r.MaxDD,0).toFixed(3)}</td>
      <td class="num">${num(r.riskScoreN,0).toFixed(1)}</td>
    </tr>`).join('');

  const st=document.querySelector('#simTable tbody');
  st.innerHTML = lastRows.map(r=>`
    <tr>
      <heinzer style="display:none"></tr>
    `).join('');

  st.innerHTML = lastRows.map(r=>`
    <tr>
      <td>${r.h_ms}</td>
      <td class="num">${num(r.trades,0)}</td>
      <td class="num">${num(r.total_pnl_bps,0).toFixed(3)}</td>
      <td class="num">${num(r.avg_pnl_bps,0).toFixed(3)}</td>
      <td class="num">${num(r.med_pnl_bps,0).toFixed(3)}</td>
      <td class="num">${num(r.win_pct,0).toFixed(1)}</td>
      <td class="num">${num(r.perfScoreN,0).toFixed(1)}</td>
    </tr>`).join('');
}

function updateRecommendations(){
  const topk = +document.getElementById('topk').value || 3;
  recomputeScoresAndNormalize();

  const topRisk = lastRows.slice().sort((a,b)=>b.riskScoreN-a.riskScoreN).slice(0,topk);
  const topPerf = lastRows.slice().sort((a,b)=>b.perfScoreN-a.perfScoreN).slice(0,topk);

  document.getElementById('recsRisk').innerHTML =
    topRisk.map((r,i)=>`<span class="pill ${i===0?'good':'warn'}">${r.h_ms} ms • ${r.riskScoreN.toFixed(1)}</span>`).join('');

  document.getElementById('recsPerf').innerHTML =
    topPerf.map((r,i)=>`<span class="pill ${i===0?'good':'alt'}">${r.h_ms} ms • ${r.perfScoreN.toFixed(1)}</span>`).join('');
}

function scaleForWidth(px){ if(px <= 420) return 11; if(px <= 560) return 12; if(px <= 720) return 13; return 14; }
function syncTableFontSizes(){
  const riskCanvas = document.getElementById('riskChart');
  const pnlCanvas  = document.getElementById('pnlChart');
  if(riskCanvas){
    const w = riskCanvas.getBoundingClientRect().width || 600;
    document.getElementById('riskTable').style.fontSize = scaleForWidth(w) + 'px';
  }
  if(pnlCanvas){
    const w = pnlCanvas.getBoundingClientRect().width || 600;
    document.getElementById('simTable').style.fontSize  = scaleForWidth(w) + 'px';
  }
}

/* -------- Tag bar / status -------- */
function renderTagBar(sym, asof, viewTag, rows){
  const tagBar = document.getElementById('tagBar');
  const viewPill = document.getElementById('viewPill');

  const tinfo = tagClass(viewTag);
  viewPill.className = `pill ${tinfo.cls}`;
  viewPill.innerHTML = `<span class="badgeDot ${tinfo.dot}"></span><b>${tinfo.label}</b> view`;

  if(!rows.length){
    tagBar.innerHTML = '';
    return;
  }

  // Collect metadata (use first row; all same file/window)
  const r0 = rows[0];
  const backend = String(r0.tag||"UNK");
  const autoT = String(r0.auto_tag||"UNK");
  const mismatch = rows.some(r=>r.tag_mismatch);

  const b = tagClass(backend);
  const a = tagClass(autoT);

  const mismatchPill = mismatch
    ? `<span class="pill tagBAD"><span class="badgeDot dotBAD"></span><b>TAG MISMATCH</b> backend=${backend} auto=${autoT}</span>`
    : `<span class="pill tagOS" style="opacity:.75"><span class="badgeDot dotOS"></span>Tag check OK</span>`;

  const backendPill = `<span class="pill ${b.cls}"><span class="badgeDot ${b.dot}"></span><b>backend:</b> ${backend}</span>`;
  const autoPill    = `<span class="pill ${a.cls}"><span class="badgeDot ${a.dot}"></span><b>auto:</b> ${autoT}</span>`;

  const winPill = `<span class="pill"><b>train window:</b> ${r0.model_start || '—'} → ${r0.model_end || '—'}</span>`;
  const srcPill = `<span class="pill"><b>src:</b> ${r0.src_file || '—'}</span>`;

  tagBar.innerHTML = backendPill + autoPill + mismatchPill + winPill + srcPill;
}

/* -------- Compare OS vs IS (same asof/sym) -------- */
function renderCompare(asof, sym){
  const box = document.getElementById('compareBox');
  const on = document.getElementById('compareToggle').checked;
  if(!on){
    box.style.display = 'none';
    return;
  }

  // Build both
  const os = buildRowsFor(asof, sym, "OS").rows;
  const is = buildRowsFor(asof, sym, "IS").rows;
  if(!os.length || !is.length){
    box.style.display = 'block';
    document.querySelector('#cmpTable tbody').innerHTML =
      `<tr><td colspan="7" class="muted">Need both OS and IS for this (asof,symbol). Found OS=${os.length} IS=${is.length}.</td></tr>`;
    return;
  }

  // Recompute scores for each set under current sliders
  const save = lastRows;

  lastRows = os.slice(); recomputeScoresAndNormalize();
  const osMap = new Map(lastRows.map(r=>[r.h_ms, {...r}]));

  lastRows = is.slice(); recomputeScoresAndNormalize();
  const isMap = new Map(lastRows.map(r=>[r.h_ms, {...r}]));

  lastRows = save;

  const common = Array.from(osMap.keys()).filter(h=>isMap.has(h)).sort((a,b)=>a-b);

  const tbody = document.querySelector('#cmpTable tbody');
  if(!common.length){
    tbody.innerHTML = `<tr><td colspan="7" class="muted">No overlapping horizons between OS and IS.</td></tr>`;
    box.style.display = 'block';
    return;
  }

  const fmt = (v, d=2)=> (Number.isFinite(v) ? (+v).toFixed(d) : '—');

  tbody.innerHTML = common.map(h=>{
    const o = osMap.get(h), i = isMap.get(h);
    return `
      <tr>
        <td>${h}</td>
        <td class="num">${fmt(o.riskScoreN - i.riskScoreN, 2)}</td>
        <td class="num">${fmt(o.perfScoreN - i.perfScoreN, 2)}</td>
        <td class="num">${fmt((o.Sharpe??0) - (i.Sharpe??0), 3)}</td>
        <td class="num">${fmt(o.MaxDD - i.MaxDD, 3)}</td>
        <td class="num">${fmt(o.total_pnl_bps - i.total_pnl_bps, 3)}</td>
        <td class="num">${fmt(o.win_pct - i.win_pct, 2)}</td>
      </tr>`;
  }).join('');

  box.style.display = 'block';
}

async function render(){
  const asof = document.getElementById('asof').value;
  const sym  = document.getElementById('instrument').value;

  const viewMode = document.getElementById('tagSel').value;
  const tag = resolveViewTag(viewMode, asof, sym);

  const key = `${asof}_${sym}_${tag}`;
  const seq = ++renderSeq; currentKey = key;

  if(pnlChart){ pnlChart.destroy(); pnlChart = null; }
  if(riskChart){ riskChart.destroy(); riskChart = null; }

  document.querySelector('#riskTable tbody').innerHTML = '';
  document.querySelector('#simTable tbody').innerHTML = '';
  document.getElementById('recsRisk').innerHTML = '';
  document.getElementById('recsPerf').innerHTML = '';
  document.getElementById('anchorChecks').innerHTML = '';
  document.getElementById('anchorChecksRisk').innerHTML = '';
  document.getElementById('status').textContent = '';
  document.getElementById('tagBar').innerHTML = '';
  document.getElementById('compareBox').style.display = 'none';

  if(!cache[key]){
    cache[key] = buildRowsFor(asof, sym, tag);
  }
  if(seq !== renderSeq || key !== currentKey) return;

  const built = cache[key];
  lastRows = (built.rows || []).slice().sort((a,b)=>a.h_ms-b.h_ms);

  if(!lastRows.length){
    const avail = tagsAvailable(asof, sym);
    document.getElementById('recsRisk').innerHTML =
      `<span class="pill warn">No rows for ${sym} • ${asof} • tag=${tag} (available: ${avail.join(', ') || 'none'})</span>`;
    document.getElementById('status').textContent =
      `Source: ${JSON_URL} • No rows for ${sym} asof=${asof} tag=${tag}`;
    renderTagBar(sym, asof, tag, []);
    return;
  }

  // Visible differentiation + safety check pills
  renderTagBar(sym, asof, tag, lastRows);

  recomputeScoresAndNormalize();
  buildAnchorChecksRisk(lastRows); updateRiskChart();
  buildAnchorChecksPerf(lastRows); updatePerfChart();
  renderTables(); updateRecommendations(); syncTableFontSizes(); syncChartCardHeights();

  const dupMsg = (built.meta && built.meta.dup_horizons > 0)
    ? ` • WARNING: dup_horizons=${built.meta.dup_horizons}`
    : '';
  const mismatch = lastRows.some(r=>r.tag_mismatch) ? " • TAG_MISMATCH=YES" : "";
  document.getElementById('status').textContent =
    `Source: ${JSON_URL} • ${sym} • asof=${asof} • view=${tag}${mismatch} • rows=${lastRows.length}${dupMsg}`;

  renderCompare(asof, sym);
}

['asof','instrument','tagSel','topk'].forEach(id=>{
  document.getElementById(id).addEventListener('change', ()=>{
    render();
    setTimeout(syncChartCardHeights,0);
  });
});

document.getElementById('compareToggle').addEventListener('change', ()=>{
  render(); // simplest: rerender compare table
});

['risk','perf'].forEach(id=>{
  document.getElementById(id).addEventListener('input', ()=>{
    if(!lastRows.length) return;
    updateRiskChart();
    updatePerfChart();
    updateRecommendations();
    syncTableFontSizes();
    syncChartCardHeights();

    // update compare deltas live
    const asof = document.getElementById('asof').value;
    const sym  = document.getElementById('instrument').value;
    renderCompare(asof, sym);
  });
});

window.addEventListener('resize', ()=>{ syncTableFontSizes(); syncChartCardHeights(); });

(async function boot(){
  try{
    RAW = await loadJSON();
    RAW.forEach(r => {
      if(r.symbol) r.symbol = String(r.symbol).toUpperCase();
      if(r.tag) r.tag = String(r.tag).toUpperCase();
      if(r.asof) r.asof = String(r.asof);
    });

    populateAsofs();
    render();
  }catch(e){
    document.getElementById('recsRisk').innerHTML = `<span class="pill warn">${e?.message || e}</span>`;
    document.getElementById('status').textContent = `Load error: ${e?.message || e}`;
  }
})();
</script>
</body>
</html>
